{% extends "base.html" %}

{% block title %}Input Transaction - Luni Web{% endblock %}

{% block content %}
<div class="card">
    <h1>‚ûï Input Transaction</h1>
    <p style="color: #8b4513; margin-bottom: 30px; font-size: 16px;">
        Manually enter transaction details
    </p>
    
    <form method="POST" onsubmit="return validateForm(this)">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <!-- Basic Information -->
            <div style="background: rgba(255, 255, 255, 0.7); border-radius: 15px; padding: 20px; border: 2px solid rgba(212, 175, 55, 0.2);">
                <h3 style="color: #8b4513; margin-bottom: 15px; font-weight: 600;">üìù Basic Information</h3>
                
                <div class="form-group">
                    <label for="date">Date *</label>
                    <input type="date" id="date" name="date" class="form-control" value="{{ moment().format('YYYY-MM-DD') if moment else '' }}" required>
                </div>
                
                <div class="form-group">
                    <label for="description">Description *</label>
                    <input type="text" id="description" name="description" class="form-control" placeholder="e.g., Grocery shopping at Safeway" required>
                </div>
                
                <div class="form-group">
                    <label for="amount">Amount *</label>
                    <input type="number" id="amount" name="amount" step="0.01" class="form-control" placeholder="0.00" required onchange="updateAmountColor()">
                    <small style="color: #7f8c8d; font-size: 12px;">Use negative values for expenses, positive for income</small>
                </div>
                
                <div class="form-group">
                    <label for="type">Type *</label>
                    <select id="type" name="type" class="form-control" required onchange="updateTypeDisplay()">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
            </div>
            
            <!-- Categorization -->
            <div style="background: rgba(255, 255, 255, 0.7); border-radius: 15px; padding: 20px; border: 2px solid rgba(212, 175, 55, 0.2);">
                <h3 style="color: #8b4513; margin-bottom: 15px; font-weight: 600;">üè∑Ô∏è Categorization</h3>
                
                <div class="form-group">
                    <label for="parent_account">Parent Account</label>
                    <select id="parent_account" name="parent_account" class="form-control" onchange="updateSubAccounts()">
                        <option value="">Select Parent Account</option>
                        {% for parent_name in parent_accounts.keys() %}
                        <option value="{{ parent_name }}">{{ parent_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="account">Account *</label>
                    <select id="account" name="account" class="form-control" required>
                        <option value="">Select Account</option>
                        {% for parent_name, sub_accounts in parent_accounts.items() %}
                            {% for sub_account in sub_accounts %}
                            <option value="{{ sub_account }}" data-parent="{{ parent_name }}">{{ sub_account }}</option>
                            {% endfor %}
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <!-- People & Payment -->
            <div style="background: rgba(255, 255, 255, 0.7); border-radius: 15px; padding: 20px; border: 2px solid rgba(212, 175, 55, 0.2);">
                <h3 style="color: #8b4513; margin-bottom: 15px; font-weight: 600;">üë• People & Payment</h3>
                
                <div class="form-group">
                    <label for="who_paid">Who Paid *</label>
                    <select id="who_paid" name="who_paid" class="form-control" required>
                        <option value="">Select Person</option>
                        {% for roommate in roommates %}
                        <option value="{{ roommate }}">{{ roommate }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="who_will_use">Who Will Use *</label>
                    <input type="text" id="who_will_use" name="who_will_use" class="form-control" placeholder="e.g., Rory, Rayna, John" required>
                    <small style="color: #7f8c8d; font-size: 12px;">Separate multiple people with commas</small>
                </div>
                
                <div class="form-group">
                    <label for="method_of_payment">Payment Method *</label>
                    <select id="method_of_payment" name="method_of_payment" class="form-control" required>
                        <option value="">Select Method</option>
                        {% for method in payment_methods %}
                        <option value="{{ method }}">{{ method }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div style="margin-top: 30px; text-align: center;">
            <button type="submit" class="btn btn-success" style="padding: 15px 30px; font-size: 16px;">
                ‚ûï Add Transaction
            </button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary" style="padding: 15px 30px; font-size: 16px; margin-left: 15px;">
                üìä Back to Dashboard
            </a>
        </div>
    </form>
</div>

<!-- Help Section -->
<div class="card">
    <h2>‚ùì Help & Tips</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div style="background: rgba(52, 152, 219, 0.1); border-radius: 12px; padding: 15px; border-left: 4px solid #3498db;">
            <h4 style="color: #3498db; margin-bottom: 10px;">üí∞ Amount Guidelines</h4>
            <ul style="color: #8b4513; font-size: 14px; margin: 0; padding-left: 20px;">
                <li>Use <strong>negative values</strong> for expenses (e.g., -50.00)</li>
                <li>Use <strong>positive values</strong> for income (e.g., 100.00)</li>
                <li>Include cents for accuracy (e.g., 25.99)</li>
            </ul>
        </div>
        
        <div style="background: rgba(39, 174, 96, 0.1); border-radius: 12px; padding: 15px; border-left: 4px solid #27ae60;">
            <h4 style="color: #27ae60; margin-bottom: 10px;">üë• Sharing Expenses</h4>
            <ul style="color: #8b4513; font-size: 14px; margin: 0; padding-left: 20px;">
                <li>List all people who will share the expense</li>
                <li>Separate names with commas (e.g., "Rory, Rayna")</li>
                <li>The system will calculate individual amounts</li>
            </ul>
        </div>
        
        <div style="background: rgba(243, 156, 18, 0.1); border-radius: 12px; padding: 15px; border-left: 4px solid #f39c12;">
            <h4 style="color: #f39c12; margin-bottom: 10px;">üè∑Ô∏è Categorization</h4>
            <ul style="color: #8b4513; font-size: 14px; margin: 0; padding-left: 20px;">
                <li>Choose a parent account first (e.g., "Food")</li>
                <li>Then select a specific sub-account (e.g., "Groceries")</li>
                <li>This helps with detailed spending analysis</li>
            </ul>
        </div>
        
        <div style="background: rgba(155, 89, 182, 0.1); border-radius: 12px; padding: 15px; border-left: 4px solid #9b59b6;">
            <h4 style="color: #9b59b6; margin-bottom: 10px;">‚ö° Quick Entry</h4>
            <ul style="color: #8b4513; font-size: 14px; margin: 0; padding-left: 20px;">
                <li>Use the <strong>Upload</strong> feature for receipts</li>
                <li>CSV import for multiple transactions</li>
                <li>AI parsing for automatic data extraction</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set today's date as default
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('date');
        if (!dateInput.value) {
            dateInput.value = today;
        }
        
        // Initialize sub-account filtering
        updateSubAccounts();
    });

    function updateAmountColor() {
        const amountInput = document.getElementById('amount');
        const amount = parseFloat(amountInput.value);
        
        if (amount < 0) {
            amountInput.style.color = '#e74c3c';
            amountInput.style.fontWeight = 'bold';
        } else if (amount > 0) {
            amountInput.style.color = '#27ae60';
            amountInput.style.fontWeight = 'bold';
        } else {
            amountInput.style.color = '#7f8c8d';
            amountInput.style.fontWeight = 'normal';
        }
    }

    function updateTypeDisplay() {
        const typeSelect = document.getElementById('type');
        const amountInput = document.getElementById('amount');
        const amount = parseFloat(amountInput.value);
        
        if (typeSelect.value === 'income' && amount < 0) {
            // Convert negative expense to positive income
            amountInput.value = Math.abs(amount);
            updateAmountColor();
        } else if (typeSelect.value === 'expense' && amount > 0) {
            // Convert positive income to negative expense
            amountInput.value = -amount;
            updateAmountColor();
        }
    }

    function updateSubAccounts() {
        const parentSelect = document.getElementById('parent_account');
        const accountSelect = document.getElementById('account');
        const selectedParent = parentSelect.value;
        
        // Store all original options for reference (only once)
        if (!window.allAccountOptions) {
            window.allAccountOptions = Array.from(accountSelect.querySelectorAll('option[data-parent]'));
        }
        
        // Clear existing options except the first one
        accountSelect.innerHTML = '<option value="">Select Account</option>';
        
        if (selectedParent && selectedParent !== '') {
            // Add options for the selected parent (avoid duplicates)
            const addedValues = new Set();
            window.allAccountOptions.forEach(option => {
                if (option.getAttribute('data-parent') === selectedParent) {
                    const optionValue = option.value;
                    if (!addedValues.has(optionValue)) {
                        accountSelect.appendChild(option.cloneNode(true));
                        addedValues.add(optionValue);
                    }
                }
            });
        } else {
            // Show all accounts (avoid duplicates)
            const addedValues = new Set();
            window.allAccountOptions.forEach(option => {
                const optionValue = option.value;
                if (!addedValues.has(optionValue)) {
                    accountSelect.appendChild(option.cloneNode(true));
                    addedValues.add(optionValue);
                }
            });
        }
    }

    function validateForm(form) {
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.style.borderColor = '#e74c3c';
                isValid = false;
            } else {
                field.style.borderColor = '';
            }
        });
        
        // Validate amount
        const amount = parseFloat(document.getElementById('amount').value);
        if (isNaN(amount) || amount === 0) {
            document.getElementById('amount').style.borderColor = '#e74c3c';
            showNotification('Please enter a valid non-zero amount', 'error');
            isValid = false;
        }
        
        // Validate who_will_use format
        const whoWillUse = document.getElementById('who_will_use').value.trim();
        if (whoWillUse && !whoWillUse.includes(',')) {
            // Single person - validate they exist in roommates
            const roommates = Array.from(document.getElementById('who_paid').options).map(opt => opt.value);
            if (!roommates.includes(whoWillUse)) {
                document.getElementById('who_will_use').style.borderColor = '#f39c12';
                showNotification('Person not found in roommates list. Add them in Information section first.', 'warning');
            }
        }
        
        if (!isValid) {
            showNotification('Please fill in all required fields', 'error');
        }
        
        return isValid;
    }

    // Initialize the form when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize sub-account filtering
        updateSubAccounts();
    });
</script>
{% endblock %}
