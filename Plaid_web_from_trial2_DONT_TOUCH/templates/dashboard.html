{% extends "base.html" %}

{% block title %}Dashboard - Luni Web{% endblock %}

{% block content %}
<div class="card">
    <h1>📊 Dashboard Overview</h1>
    
    <!-- Statistics Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ stats.get('total_transactions', 0) }}</div>
            <div class="stat-label">Total Transactions</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.get('total_roommates', 0) }}</div>
            <div class="stat-label">Roommates</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.get('total_accounts', 0) }}</div>
            <div class="stat-label">Account Categories</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${{ "%.2f"|format(month_spending.get('total_spending', 0)) }}</div>
            <div class="stat-label">This Month</div>
        </div>
    </div>
</div>

<!-- Spending Summary -->
<div class="card">
    <h2>💰 Spending Summary</h2>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">${{ "%.2f"|format(week_spending.get('total_spending', 0)) }}</div>
            <div class="stat-label">This Week</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${{ "%.2f"|format(month_spending.get('total_spending', 0)) }}</div>
            <div class="stat-label">This Month</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${{ "%.2f"|format(quarter_spending.get('total_spending', 0)) }}</div>
            <div class="stat-label">This Quarter</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ month_spending.get('transaction_count', 0) }}</div>
            <div class="stat-label">Monthly Transactions</div>
        </div>
    </div>
    
    <!-- Spending by Person -->
    {% if month_spending.get('by_person') %}
    <div style="margin-top: 30px;">
        <h3 style="color: #8b4513; margin-bottom: 20px;">💸 This Month by Person</h3>
        <div class="table-container">
            <table class="enhanced-table">
                <thead>
                    <tr>
                        <th>Person</th>
                        <th>Amount Spent</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for person, amount in month_spending.by_person.items() %}
                    <tr>
                        <td>{{ person }}</td>
                        <td class="{{ 'text-red-600' if amount < 0 else 'text-green-600' }}">${{ "%.2f"|format(amount) }}</td>
                        <td>{{ "%.1f"|format((amount / month_spending.total_spending * 100) if month_spending.total_spending > 0 else 0) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<!-- Roommate Balances -->
<div class="card">
    <h2>⚖️ Roommate Balances</h2>
    <p style="color: #8b4513; margin-bottom: 20px; font-size: 14px;">
        Green = You're owed money, Red = You owe money
    </p>
    
    {% if balances %}
    <div class="table-container">
        <table class="enhanced-table">
            <thead>
                <tr>
                    <th>Roommate</th>
                    <th>Balance</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for person, balance in balances.items() %}
                <tr>
                    <td>{{ person }}</td>
                    <td class="{{ 'balance-positive' if balance > 0 else 'balance-negative' }}">
                        ${{ "%.2f"|format(balance) }}
                    </td>
                    <td>
                        {% if balance > 0 %}
                            <span style="color: #27ae60; font-weight: 600;">💰 Owed Money</span>
                        {% elif balance < 0 %}
                            <span style="color: #e74c3c; font-weight: 600;">💸 Owes Money</span>
                        {% else %}
                            <span style="color: #7f8c8d; font-weight: 600;">✅ Even</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="color: #8b4513; font-style: italic; text-align: center; padding: 20px;">
        No roommate balances to display. Add some transactions to see balances.
    </p>
    {% endif %}
</div>

<!-- Spending by Category -->
<div class="card">
    <h2>📊 Spending by Category</h2>
    <p style="color: #8b4513; margin-bottom: 20px; font-size: 14px;">
        This month's spending breakdown by parent account
    </p>
    
    {% if parent_account_spending %}
    <div class="table-container">
        <table class="enhanced-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Total Spent</th>
                    <th>Transactions</th>
                    <th>Top Sub-Account</th>
                </tr>
            </thead>
            <tbody>
                {% for category, data in parent_account_spending.items() %}
                {% if data.total > 0 %}
                <tr>
                    <td>
                        <strong>{{ category }}</strong>
                        {% if category in parent_accounts %}
                        <div style="font-size: 12px; color: #7f8c8d;">
                            {{ parent_accounts[category]|length }} sub-accounts
                        </div>
                        {% endif %}
                    </td>
                    <td class="text-red-600">${{ "%.2f"|format(data.total) }}</td>
                    <td>{{ data.transaction_count }}</td>
                    <td>
                        {% if data.by_sub_account %}
                            {% set top_sub = data.by_sub_account.items()|list %}
                            {% if top_sub %}
                                {% set max_item = top_sub[0] %}
                                {% for item in top_sub %}
                                    {% if item[1] > max_item[1] %}
                                        {% set max_item = item %}
                                    {% endif %}
                                {% endfor %}
                                {{ max_item[0] }} (${{ "%.2f"|format(max_item[1]) }})
                            {% else %}
                                N/A
                            {% endif %}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="color: #8b4513; font-style: italic; text-align: center; padding: 20px;">
        No spending data available for this month.
    </p>
    {% endif %}
</div>

<!-- Quick Actions -->
<div class="card">
    <h2>🚀 Quick Actions</h2>
    <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
        <a href="{{ url_for('upload') }}" class="btn">
            📤 Upload Receipt
        </a>
        <a href="{{ url_for('input_transaction') }}" class="btn">
            ➕ Add Transaction
        </a>
        <a href="{{ url_for('all_transactions') }}" class="btn">
            📋 View All Transactions
        </a>
        <a href="{{ url_for('information') }}" class="btn">
            ⚙️ Manage Settings
        </a>
    </div>
</div>

<!-- Recent Activity -->
<div class="card">
    <h2>🕒 Recent Activity</h2>
    <p style="color: #8b4513; margin-bottom: 20px; font-size: 14px;">
        Latest transactions and system updates
    </p>
    
    <div style="background: rgba(212, 175, 55, 0.05); border-radius: 12px; padding: 20px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
            <span style="background: #3498db; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 12px;">📊</span>
            <div>
                <strong>Dashboard Loaded</strong>
                <div style="font-size: 12px; color: #7f8c8d;">{{ stats.get('last_updated', 'Unknown') }}</div>
            </div>
        </div>
        
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
            <span style="background: #27ae60; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 12px;">💰</span>
            <div>
                <strong>{{ stats.get('total_transactions', 0) }} Total Transactions</strong>
                <div style="font-size: 12px; color: #7f8c8d;">Across {{ stats.get('total_accounts', 0) }} account categories</div>
            </div>
        </div>
        
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="background: #e74c3c; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 12px;">👥</span>
            <div>
                <strong>{{ stats.get('total_roommates', 0) }} Roommates</strong>
                <div style="font-size: 12px; color: #7f8c8d;">Managing shared expenses</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh dashboard data every 30 seconds
    setInterval(function() {
        fetch('/api/statistics')
            .then(response => response.json())
            .then(data => {
                if (data.stats) {
                    // Update statistics without page reload
                    console.log('Dashboard data updated:', data);
                }
            })
            .catch(error => {
                console.error('Error updating dashboard:', error);
            });
    }, 30000);

    // Add click handlers for interactive elements
    document.addEventListener('DOMContentLoaded', function() {
        // Add hover effects to stat cards
        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
    });
</script>
{% endblock %}
