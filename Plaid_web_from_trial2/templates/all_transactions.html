{% extends "base.html" %}

{% block title %}All Transactions - Luni Web{% endblock %}

{% block content %}
<div class="card">
    <h1>üìã All Transactions</h1>
    
    <!-- Period Totals Overview -->
    <div style="background: rgba(255, 255, 255, 0.9); border-radius: 15px; padding: 25px; margin-bottom: 25px; border: 2px solid rgba(212, 175, 55, 0.3);">
        <h3 style="color: #8b4513; margin-bottom: 20px; font-weight: 600;">üí∞ {{ default_person or 'User' }}'s Spending Overview</h3>
        
        <!-- Period Selection -->
        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
            <button class="period-btn {{ 'active' if selected_period == 'week' else '' }}" onclick="setPeriod('week')" data-period="week">üìÖ This Week</button>
            <button class="period-btn {{ 'active' if selected_period == 'month' else '' }}" onclick="setPeriod('month')" data-period="month">üìÜ This Month</button>
            <button class="period-btn {{ 'active' if selected_period == 'quarter' else '' }}" onclick="setPeriod('quarter')" data-period="quarter">üìä Last 3 Months</button>
            <button class="period-btn {{ 'active' if selected_period == 'custom' else '' }}" onclick="setPeriod('custom')" data-period="custom">üìù Custom Range</button>
        </div>
        
        <!-- Totals Display -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div class="total-card">
                <div class="total-amount" id="total-spent">${{ "%.2f"|format(spending_overview.total_spent) }}</div>
                <div class="total-label">Total Spent</div>
            </div>
            <div class="total-card">
                <div class="total-amount" id="total-income">${{ "%.2f"|format(spending_overview.total_income) }}</div>
                <div class="total-label">Total Income</div>
            </div>
            <div class="total-card">
                <div class="total-amount" id="total-oweings">${{ "%.2f"|format(spending_overview.total_oweings) }}</div>
                <div class="total-label">Total Oweings</div>
            </div>
            <div class="total-card">
                <div class="total-amount" id="net-amount">${{ "%.2f"|format(spending_overview.net_amount) }}</div>
                <div class="total-label">Net Amount</div>
            </div>
            <div class="total-card">
                <div class="total-count" id="transaction-count">{{ spending_overview.transaction_count }}</div>
                <div class="total-label">Transactions</div>
            </div>
        </div>
        
        <!-- Roommate Spending Breakdown -->
        <div style="margin-top: 20px;">
            <h4 style="color: #8b4513; margin-bottom: 15px; font-weight: 600;">üë• Roommate Spending Breakdown</h4>
            <div class="roommate-table-container">
                <table class="roommate-table">
                    <thead>
                        <tr>
                            <th>Roommate</th>
                            <th>Spent</th>
                            <th>Owes/Owed</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="roommate-breakdown-table">
                        {% for roommate, data in roommate_breakdown.items() %}
                        <tr>
                            <td><strong>{{ roommate }}</strong></td>
                            <td>${{ "%.2f"|format(data.spent) }}</td>
                            <td class="owes-amount {{ 'positive' if data.balance >= 0 else 'negative' }}">
                                {% if data.balance >= 0 %}
                                    ${{ "%.2f"|format(data.balance) }} owed
                                {% else %}
                                    ${{ "%.2f"|format(-data.balance) }} owes
                                {% endif %}
                            </td>
                            <td class="owes-amount {{ 'positive' if data.balance >= 0 else 'negative' }}">
                                ${{ "%.2f"|format(data.balance) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Filtering -->
    <div style="background: rgba(255, 255, 255, 0.7); border-radius: 15px; padding: 20px; margin-bottom: 25px; border: 2px solid rgba(212, 175, 55, 0.2);">
        <h3 style="color: #8b4513; margin-bottom: 15px; font-weight: 600;">üîç Filter Transactions</h3>
        
        <form method="GET" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
            <div class="form-group">
                <label for="start_date">Start Date:</label>
                <input type="date" id="start_date" name="start_date" class="form-control" value="{{ filters.get('start_date', '') }}">
            </div>
            <div class="form-group">
                <label for="end_date">End Date:</label>
                <input type="date" id="end_date" name="end_date" class="form-control" value="{{ filters.get('end_date', '') }}">
            </div>
            <div class="form-group">
                <label for="description">Description:</label>
                <input type="text" id="description" name="description" class="form-control" value="{{ filters.get('description', '') }}" placeholder="Search descriptions...">
            </div>
            <div class="form-group">
                <label for="who_paid">Who Paid:</label>
                <select id="who_paid" name="who_paid" class="form-control">
                    <option value="">All People</option>
                    {% for roommate in roommates %}
                    <option value="{{ roommate }}" {% if filters.get('who_paid') == roommate %}selected{% endif %}>{{ roommate }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="account">Account:</label>
                <select id="account" name="account" class="form-control">
                    <option value="">All Accounts</option>
                    {% for account in all_sub_accounts %}
                    <option value="{{ account }}" {% if filters.get('account') == account %}selected{% endif %}>{{ account }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="type">Type:</label>
                <select id="type" name="type" class="form-control">
                    <option value="">All Types</option>
                    <option value="expense" {% if filters.get('type') == 'expense' %}selected{% endif %}>Expense</option>
                    <option value="income" {% if filters.get('type') == 'income' %}selected{% endif %}>Income</option>
                </select>
            </div>
            <div class="form-group">
                <label for="method_of_payment">Payment Method:</label>
                <select id="method_of_payment" name="method_of_payment" class="form-control">
                    <option value="">All Methods</option>
                    {% for method in payment_methods %}
                    <option value="{{ method }}" {% if filters.get('method_of_payment') == method %}selected{% endif %}>{{ method }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="who_will_use">Who Will Use:</label>
                <input type="text" id="who_will_use" name="who_will_use" class="form-control" value="{{ filters.get('who_will_use', '') }}" placeholder="Search users...">
            </div>
            <div class="form-group">
                <button type="submit" class="btn">üîç Filter</button>
                <a href="{{ url_for('all_transactions') }}" class="btn btn-secondary">üîÑ Clear</a>
            </div>
        </form>
    </div>
    
    <!-- Edit Mode Toggle -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div style="display: flex; gap: 10px; align-items: center;">
            <button id="edit_mode" type="button" class="btn" onclick="toggleEditMode()" style="display: block;">
                ‚úèÔ∏è Edit Mode
            </button>
            <button id="save_mode" type="button" class="btn btn-success" onclick="saveAllChanges()" style="display: none;">
                üíæ Save Changes
            </button>
            <button id="bulk-delete-btn" onclick="deleteSelectedTransactions()" class="btn btn-danger" style="display: none;">
                üóëÔ∏è Delete Selected (<span id="selected-count">0</span>)
            </button>
        </div>
        <div>
            <a href="{{ url_for('export_transactions') }}" class="btn btn-secondary">üì§ Export CSV</a>
        </div>
    </div>
</div>

<!-- Transactions Table -->
<div class="table-container">
    {% if transactions %}
    <table class="enhanced-table">
        <thead>
            <tr>
                <th id="bulk-select-header" style="width: 50px; display: none;">
                    <input type="checkbox" id="select-all" onchange="toggleAllTransactions()">
                </th>
                <th>Date</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Type</th>
                <th>Parent Account</th>
                <th>Account</th>
                <th>Who Paid</th>
                <th>Who Will Use</th>
                <th>Payment Method</th>
                <th id="actions-header">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for transaction in transactions %}
            <tr>
                <!-- Bulk Selection Column (hidden by default) -->
                <td class="bulk-select-cell" style="display: none;">
                    <input type="checkbox" class="transaction-checkbox" value="{{ transaction.id }}" onchange="updateBulkActions()">
                </td>
                <!-- View Mode -->
                <td id="date_view_{{ transaction.id }}">{{ transaction.date }}</td>
                <td id="description_view_{{ transaction.id }}">{{ transaction.description }}</td>
                <td id="amount_view_{{ transaction.id }}" class="{{ transaction.amount_color }}">${{ "%.2f"|format(transaction.amount) }}</td>
                <td id="type_view_{{ transaction.id }}">{{ transaction.type.title() }}</td>
                <td id="parent_account_view_{{ transaction.id }}">{{ transaction.parent_account }}</td>
                <td id="account_view_{{ transaction.id }}">{{ transaction.account }}</td>
                <td id="who_paid_view_{{ transaction.id }}">{{ transaction.who_paid }}</td>
                <td id="who_will_use_view_{{ transaction.id }}">{{ transaction.who_will_use }}</td>
                <td id="method_view_{{ transaction.id }}">{{ transaction.method_of_payment }}</td>
                <td id="actions_view_{{ transaction.id }}">
                    <button onclick="deleteTransaction('{{ transaction.id }}')" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;">üóëÔ∏è</button>
                </td>
                
                <!-- Edit Mode -->
                <td id="date_edit_{{ transaction.id }}" style="display: none;">
                    <input type="date" value="{{ transaction.date }}" class="form-control" style="width: 120px;">
                </td>
                <td id="description_edit_{{ transaction.id }}" style="display: none;">
                    <input type="text" value="{{ transaction.description }}" class="form-control" style="width: 150px;">
                </td>
                <td id="amount_edit_{{ transaction.id }}" style="display: none;">
                    <input type="number" value="{{ transaction.amount }}" step="0.01" class="form-control" style="width: 100px;">
                </td>
                <td id="type_edit_{{ transaction.id }}" style="display: none;">
                    <select class="form-control" style="width: 100px;">
                        <option value="expense" {% if transaction.type == 'expense' %}selected{% endif %}>Expense</option>
                        <option value="income" {% if transaction.type == 'income' %}selected{% endif %}>Income</option>
                    </select>
                </td>
                <td id="parent_account_edit_{{ transaction.id }}" style="display: none;">
                    <select class="form-control" style="width: 120px;" onchange="filterAccountDropdownAll('{{ transaction.id }}')">
                        <option value="">Select</option>
                        {% for parent_name in parent_accounts.keys() %}
                        <option value="{{ parent_name }}" {% if transaction.parent_account == parent_name %}selected{% endif %}>{{ parent_name }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td id="account_edit_{{ transaction.id }}" style="display: none;">
                    <select class="form-control" style="width: 120px;">
                        {% for parent_name, sub_accounts in parent_accounts.items() %}
                            {% for sub_account in sub_accounts %}
                            <option value="{{ sub_account }}" data-parent="{{ parent_name }}" {% if transaction.account == sub_account %}selected{% endif %}>{{ sub_account }}</option>
                            {% endfor %}
                        {% endfor %}
                    </select>
                </td>
                <td id="who_paid_edit_{{ transaction.id }}" style="display: none;">
                    <select class="form-control" style="width: 100px;">
                        {% for roommate in roommates %}
                        <option value="{{ roommate }}" {% if transaction.who_paid == roommate %}selected{% endif %}>{{ roommate }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td id="who_will_use_edit_{{ transaction.id }}" style="display: none;">
                    <input type="text" value="{{ transaction.who_will_use }}" class="form-control" style="width: 120px;">
                </td>
                <td id="method_edit_{{ transaction.id }}" style="display: none;">
                    <select class="form-control" style="width: 120px;">
                        {% for method in payment_methods %}
                        <option value="{{ method }}" {% if transaction.method_of_payment == method %}selected{% endif %}>{{ method }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td id="actions_edit_{{ transaction.id }}" style="display: none;">
                    <button onclick="saveTransaction('{{ transaction.id }}')" class="btn btn-success" style="padding: 6px 12px; font-size: 12px;">üíæ</button>
                    <button onclick="cancelEdit('{{ transaction.id }}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">‚ùå</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div style="margin-top: 20px; text-align: center; color: #8b4513;">
        <strong>{{ transactions|length }} transactions found</strong>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; color: #8b4513;">
        <h3>No transactions found</h3>
        <p>Try adjusting your filters or add some transactions.</p>
        <a href="{{ url_for('input_transaction') }}" class="btn">‚ûï Add Transaction</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Account filtering for all transactions
    function filterAccountDropdownAll(transactionId) {
        const parentSelect = document.querySelector(`#parent_account_edit_${transactionId} select`);
        const accountSelect = document.querySelector(`#account_edit_${transactionId} select`);
        const selectedParent = parentSelect.value;
        
        // Store all original options for reference if not already stored
        if (!window.allAccountOptions) {
            window.allAccountOptions = Array.from(document.querySelectorAll('option[data-parent]'));
        }
        
        // Clear existing options
        accountSelect.innerHTML = '';
        
        if (selectedParent && selectedParent !== '') {
            // Add options for the selected parent (avoid duplicates)
            const addedValues = new Set();
            window.allAccountOptions.forEach(option => {
                if (option.getAttribute('data-parent') === selectedParent) {
                    const optionValue = option.value;
                    if (!addedValues.has(optionValue)) {
                        accountSelect.appendChild(option.cloneNode(true));
                        addedValues.add(optionValue);
                    }
                }
            });
        } else {
            // Show all accounts (avoid duplicates)
            const addedValues = new Set();
            window.allAccountOptions.forEach(option => {
                const optionValue = option.value;
                if (!addedValues.has(optionValue)) {
                    accountSelect.appendChild(option.cloneNode(true));
                    addedValues.add(optionValue);
                }
            });
        }
    }

    function toggleEditMode() {
        const editMode = document.getElementById('edit_mode').style.display === 'none';
        
        {% for transaction in transactions %}
        // Toggle view/edit for transaction {{ transaction.id }}
        document.getElementById('date_view_{{ transaction.id }}').style.display = editMode ? 'none' : 'table-cell';
        document.getElementById('date_edit_{{ transaction.id }}').style.display = editMode ? 'table-cell' : 'none';
        
        document.getElementById('description_view_{{ transaction.id }}').style.display = editMode ? 'none' : 'table-cell';
        document.getElementById('description_edit_{{ transaction.id }}').style.display = editMode ? 'table-cell' : 'none';
        
        document.getElementById('amount_view_{{ transaction.id }}').style.display = editMode ? 'none' : 'table-cell';
        document.getElementById('amount_edit_{{ transaction.id }}').style.display = editMode ? 'table-cell' : 'none';
        
        document.getElementById('type_view_{{ transaction.id }}').style.display = editMode ? 'none' : 'table-cell';
        document.getElementById('type_edit_{{ transaction.id }}').style.display = editMode ? 'table-cell' : 'none';
        
        document.getElementById('parent_account_view_{{ transaction.id }}').style.display = editMode ? 'none' : 'table-cell';
        document.getElementById('parent_account_edit_{{ transaction.id }}').style.display = editMode ? 'table-cell' : 'none';
        
        document.getElementById('account_view_{{ transaction.id }}').style.display = editMode ? 'none' : 'table-cell';
        document.getElementById('account_edit_{{ transaction.id }}').style.display = editMode ? 'table-cell' : 'none';
        
        document.getElementById('who_paid_view_{{ transaction.id }}').style.display = editMode ? 'none' : 'table-cell';
        document.getElementById('who_paid_edit_{{ transaction.id }}').style.display = editMode ? 'table-cell' : 'none';
        
        document.getElementById('who_will_use_view_{{ transaction.id }}').style.display = editMode ? 'none' : 'table-cell';
        document.getElementById('who_will_use_edit_{{ transaction.id }}').style.display = editMode ? 'table-cell' : 'none';
        
        document.getElementById('method_view_{{ transaction.id }}').style.display = editMode ? 'none' : 'table-cell';
        document.getElementById('method_edit_{{ transaction.id }}').style.display = editMode ? 'table-cell' : 'none';
        
        document.getElementById('actions_view_{{ transaction.id }}').style.display = editMode ? 'none' : 'table-cell';
        document.getElementById('actions_edit_{{ transaction.id }}').style.display = editMode ? 'table-cell' : 'none';
        {% endfor %}
        
        document.getElementById('edit_mode').style.display = editMode ? 'block' : 'none';
        document.getElementById('save_mode').style.display = editMode ? 'none' : 'block';
    }

    function saveTransaction(transactionId) {
        const updates = {};
        
        updates.date = document.querySelector(`#date_edit_${transactionId} input`).value;
        updates.description = document.querySelector(`#description_edit_${transactionId} input`).value;
        updates.amount = parseFloat(document.querySelector(`#amount_edit_${transactionId} input`).value);
        updates.type = document.querySelector(`#type_edit_${transactionId} select`).value;
        updates.parent_account = document.querySelector(`#parent_account_edit_${transactionId} select`).value;
        updates.account = document.querySelector(`#account_edit_${transactionId} select`).value;
        updates.who_paid = document.querySelector(`#who_paid_edit_${transactionId} select`).value;
        updates.who_will_use = document.querySelector(`#who_will_use_edit_${transactionId} input`).value;
        updates.method_of_payment = document.querySelector(`#method_edit_${transactionId} select`).value;
        
        makeRequest(`/update_transaction/${transactionId}`, updates)
            .then(response => {
                if (response.success) {
                    showNotification('Transaction updated successfully', 'success');
                    // Reload page to show updated data
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification(response.message || 'Failed to update transaction', 'error');
                }
            });
    }

    function cancelEdit(transactionId) {
        // Reload page to cancel changes
        location.reload();
    }

    function deleteTransaction(transactionId) {
        if (confirm('Are you sure you want to delete this transaction? This cannot be undone.')) {
            makeRequest(`/delete_transaction/${transactionId}`, {}, 'POST')
                .then(response => {
                    if (response.success) {
                        showNotification('Transaction deleted successfully', 'success');
                        // Remove row from table
                        const row = document.querySelector(`tr:has(#date_view_${transactionId})`);
                        if (row) row.remove();
                    } else {
                        showNotification(response.message || 'Failed to delete transaction', 'error');
                    }
                });
        }
    }

    // New functionality for improved all transactions
    let selectedPeriod = 'month';
    let editMode = false;

    function setPeriod(period) {
        selectedPeriod = period;
        
        // Update button states
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-period="${period}"]`).classList.add('active');
        
        // Build URL with period parameter
        const url = new URL(window.location);
        url.searchParams.set('period', period);
        
        // Clear existing date parameters when using preset periods
        if (period !== 'custom') {
            url.searchParams.delete('start_date');
            url.searchParams.delete('end_date');
        }
        
        // Navigate to the new URL
        window.location.href = url.toString();
    }

    function toggleAllTransactions() {
        const selectAll = document.getElementById('select-all');
        const checkboxes = document.querySelectorAll('.transaction-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateBulkActions();
    }

    function updateBulkActions() {
        const selectedCount = document.querySelectorAll('.transaction-checkbox:checked').length;
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
        const selectedCountSpan = document.getElementById('selected-count');
        
        if (selectedCount > 0) {
            bulkDeleteBtn.style.display = 'inline-block';
            selectedCountSpan.textContent = selectedCount;
        } else {
            bulkDeleteBtn.style.display = 'none';
        }
        
        // Update select all checkbox
        const checkboxes = document.querySelectorAll('.transaction-checkbox');
        const selectAll = document.getElementById('select-all');
        
        if (selectedCount === 0) {
            selectAll.checked = false;
            selectAll.indeterminate = false;
        } else if (selectedCount === checkboxes.length) {
            selectAll.checked = true;
            selectAll.indeterminate = false;
        } else {
            selectAll.checked = false;
            selectAll.indeterminate = true;
        }
    }

    function deleteSelectedTransactions() {
        const selectedIds = Array.from(document.querySelectorAll('.transaction-checkbox:checked'))
            .map(checkbox => checkbox.value);
        
        if (selectedIds.length === 0) {
            showNotification('No transactions selected', 'error');
            return;
        }
        
        if (confirm(`Are you sure you want to delete ${selectedIds.length} transaction(s)? This cannot be undone.`)) {
            // Delete transactions one by one
            selectedIds.forEach(id => {
                makeRequest(`/delete_transaction/${id}`, {}, 'POST')
                    .then(response => {
                        if (response.success) {
                            const row = document.querySelector(`tr:has(.transaction-checkbox[value="${id}"])`);
                            if (row) row.remove();
                        }
                    });
            });
            
            showNotification(`${selectedIds.length} transaction(s) deleted successfully`, 'success');
            updateBulkActions();
        }
    }

    // Override the existing toggleEditMode to include bulk selection
    const originalToggleEditMode = window.toggleEditMode;
    window.toggleEditMode = function() {
        editMode = !editMode;
        originalToggleEditMode();
        
        // Show/hide bulk selection column
        const bulkSelectHeader = document.getElementById('bulk-select-header');
        const bulkSelectCells = document.querySelectorAll('.bulk-select-cell');
        
        if (editMode) {
            bulkSelectHeader.style.display = 'table-cell';
            bulkSelectCells.forEach(cell => cell.style.display = 'table-cell');
        } else {
            bulkSelectHeader.style.display = 'none';
            bulkSelectCells.forEach(cell => cell.style.display = 'none');
            // Clear selections
            document.querySelectorAll('.transaction-checkbox').forEach(cb => cb.checked = false);
            updateBulkActions();
        }
    };

    // Add save changes functionality
    function saveAllChanges() {
        // Collect all edited transaction data
        const editedTransactions = [];
        const transactionRows = document.querySelectorAll('tbody tr');
        
        transactionRows.forEach(row => {
            // Check if this row has editable fields (in edit mode)
            const editInputs = row.querySelectorAll('input, select');
            if (editInputs.length > 0) {
                const transactionId = row.querySelector('input[name*="id"]')?.value || 
                                    row.querySelector('.transaction-checkbox')?.value;
                
                if (transactionId) {
                    const transactionData = { id: transactionId };
                    
                    // Collect all form data from this row
                    editInputs.forEach(input => {
                        const fieldName = input.name;
                        if (fieldName && fieldName.includes('_')) {
                            const field = fieldName.split('_').pop();
                            transactionData[field] = input.value;
                        }
                    });
                    
                    // Also collect select dropdown values
                    const selects = row.querySelectorAll('select');
                    selects.forEach(select => {
                        const fieldName = select.name;
                        if (fieldName && fieldName.includes('_')) {
                            const field = fieldName.split('_').pop();
                            transactionData[field] = select.value;
                        }
                    });
                    
                    editedTransactions.push(transactionData);
                }
            }
        });
        
        if (editedTransactions.length === 0) {
            // No edits made, just exit edit mode
            toggleEditMode();
            showNotification('No changes to save', 'info');
            return;
        }
        
        // Send the updated transactions to the server
        fetch('/save_all_changes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ transactions: editedTransactions })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                // Exit edit mode and reload page to show updated data
                toggleEditMode();
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showNotification(data.message || 'Failed to save changes', 'error');
            }
        })
        .catch(error => {
            console.error('Error saving changes:', error);
            showNotification('Error saving changes', 'error');
        });
    }

    // Initialize period selection on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Period selection is now handled server-side
        // No need to set default period here
    });
</script>

<style>
.period-btn {
    padding: 10px 20px;
    border: 2px solid rgba(212, 175, 55, 0.3);
    background: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
}

.period-btn:hover {
    background: rgba(212, 175, 55, 0.1);
    border-color: rgba(212, 175, 55, 0.5);
}

.period-btn.active {
    background: linear-gradient(135deg, #d4af37, #f4d03f);
    color: white;
    border-color: #d4af37;
}

.total-card {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    border: 1px solid rgba(212, 175, 55, 0.2);
}

.total-amount {
    font-size: 24px;
    font-weight: bold;
    color: #d4af37;
    margin-bottom: 5px;
}

.total-count {
    font-size: 24px;
    font-weight: bold;
    color: #d4af37;
    margin-bottom: 5px;
}

.total-label {
    color: #8b4513;
    font-weight: 500;
    font-size: 14px;
}

.roommate-card {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    border: 1px solid rgba(212, 175, 55, 0.2);
}

.roommate-name {
    font-weight: 600;
    color: #8b4513;
    margin-bottom: 5px;
}

.roommate-amount {
    font-size: 18px;
    font-weight: bold;
}

.roommate-amount.positive {
    color: #28a745;
}

.roommate-amount.negative {
    color: #dc3545;
}

.bulk-select-cell {
    text-align: center;
}

#bulk-delete-btn {
    margin-left: 10px;
}

.roommate-table-container {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
}

.roommate-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 10px;
    overflow: hidden;
}

.roommate-table th {
    background: linear-gradient(135deg, #8b4513, #d4af37);
    color: white;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
}

.roommate-table td {
    padding: 12px;
    border-bottom: 1px solid rgba(212, 175, 55, 0.1);
    font-size: 14px;
}

.roommate-table tr:hover {
    background: rgba(212, 175, 55, 0.05);
}

.roommate-table tr:last-child td {
    border-bottom: none;
}

.owes-amount {
    font-weight: bold;
}

.owes-amount.positive {
    color: #27ae60;
}

.owes-amount.negative {
    color: #e74c3c;
}
</style>
{% endblock %}
